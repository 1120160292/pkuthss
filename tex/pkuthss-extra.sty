% vim:ft=tex:ts=2:sw=2
%
% Peking University dissertation document class
%
% Copyright (c) 2008-2009 solvethis
% Copyright (c) 2010-2011 Casper Ti. Vector
%
% This work may be distributed and/or modified under the conditions of the
% LaTeX Project Public License, either version 1.3 of this license or (at
% your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX version
% 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% The current maintainer of this work is Casper Ti. Vector.
%
% This work consists of the following files:
%   pkuthss.cls
%   pkuthss-gbk.def
%   pkuthss-utf8.def
%   pkuthss-extra.sty

\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{pkuthss-extra}
	[2011/06/26 v1.3 rc2 Common extra settings for the pkuthss document class]

% Check the dependency of pkuthss.
\@ifclassloaded{pkuthss}{}{
	\PackageError{pkuthss-extra}%
		{The pkuthss document class is not loaded}%
		{The pkuthss-extra package depends on the pkuthss document class.}
}

% eg. `\pkuthss@int@extraopt{spacing}' will expand to:
%   \newif\ifpkuthss@extraopt@spacing \pkuthss@extraopt@spacingtrue
%   \DeclareOption{spacing}{\pkuthss@extraopt@spacingtrue}
%   \DeclareOption{nospacing}{\pkuthss@extraopt@spacingfalse}
\def\pkuthss@int@extraopt#1{
	\expandafter\newif\csname ifpkuthss@extraopt@#1\endcsname
	\csname pkuthss@extraopt@#1true\endcsname
	\expandafter\DeclareOption{#1}{\csname pkuthss@extraopt@#1true\endcsname}
	\expandafter\DeclareOption{no#1}%
		{\csname pkuthss@extraopt@#1false\endcsname}
}
% Whethet to use some common settings for adjusting spacing.
\pkuthss@int@extraopt{spacing}
% Whether to use list environments that are tighter than LaTeX defaults.
\pkuthss@int@extraopt{tightlist}
% Whether to use some common settings about table of contents, bibliography and
% indexes.
\pkuthss@int@extraopt{tocbibind}
% Whether to enable the `\spacialchap' command.
\pkuthss@int@extraopt{spechap}
% Whether to make citation labels superscript as default.
\pkuthss@int@extraopt{upcite}
% Whether to automatically set metadata for generated PDF from user defined
% document information.
\pkuthss@int@extraopt{pdfmeta}
% Whether to use coloured hyperlinks in generated PDF.
\pkuthss@int@extraopt{linkcolor}
% Process all class options now.
\ProcessOptions\relax

\ifpkuthss@extraopt@spacing
	% Automatically ignore spaces between CJK characters and preserve spaces in other
	% situations. XeCJK itself will handle this issue, therefore we do not use
	% `CJKspace' when using XeLaTeX.
	\ifxetex\else\RequirePackage{CJKspace}\fi
	% Make spacing nicer in some situations (eg. footnotes and verbatims).
	\RequirePackage{setspace}
	% Make the type page centered.
	\geometry{centering}
	% Set line skip.
	\linespread{1.41}\selectfont
	% Automatically insert a space between the label and the text in footnotes.
	\RequirePackage{footmisc}
	\renewcommand{\footnotelayout}{\ }
\fi

\ifpkuthss@extraopt@tightlist
	% Lists often appear to be too sparse when items are just one or two lines long.
	% Here we cancel the extra vertical spacing between list items.
	\RequirePackage{enumitem}
	\setlist{nolistsep}
	% Similarly for bibliography items.
	\setlength{\bibsep}{\parsep}
\fi

\ifpkuthss@extraopt@tocbibind
	% Add bibliography and indexes in table of contents, but not contents itself.
	\RequirePackage[nottoc]{tocbibind}
	% Add PDF bookmark for table of contents.
	\let\tmp@tableofcontents\tableofcontents
	\renewcommand{\tableofcontents}{
		% Make the `Contents' bookmark point correctly to the title of the table of
		% contents.
		\cleardoublepage
		% Actually add the PDF bookmark.
		\pdfbookmark[1]{\contentsname}{contents}
		\tmp@tableofcontents
	}
\fi

\ifpkuthss@extraopt@spechap
	% This command is used to start a chapter without numbering, and correctly set
	% the headers and footers in the chapter.
	\newcommand\specialchap[1]{
		\chapter*{#1}\addcontentsline{toc}{chapter}{#1}
		\markboth{#1}{}\phantomsection
	}
\fi

\ifpkuthss@extraopt@upcite
	% Make citation labels superscript as default.
	\setcitestyle{super,square,comma}
\fi

\AtBeginDocument{
	\ifpkuthss@extraopt@pdfmeta
		% Automatically generate metadata for generated PDF.
		\newcommand{\setpdfmetadata}{
			\hypersetup{
				pdfauthor={\@eauthor},pdftitle={\@etitle},
				pdfsubject={\euniversity\ \ethesisname},pdfkeywords={\@ekeywords}
			}
		}
		% Set the metadata when generating the title page because the document
		% information should have been all defined before this.
		\let\tmp@maketitle\maketitle
		% NOTE: `\hypersetup' must appear before `\maketitle', otherwise it might not
		% act as you wished.
		\renewcommand\maketitle{\setpdfmetadata\tmp@maketitle}
	\fi

	\ifpkuthss@extraopt@linkcolor
		% Use coloured hyperlinks in generated PDF.
		\hypersetup{colorlinks=true}
	\else hyperlinks in generated PDF.
		% Set hyperlink colour to black in order to prevent hyperlinks from being too
		% hard-to-recognise in printed thesis.
		\hypersetup{colorlinks=false, pdfborder={0 0 0}}
	\fi
}

\endinput
