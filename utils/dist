#!/usr/bin/make -f
# vim:ts=4:sw=4
#
# Copyright (c) 2011-2012 Casper Ti. Vector
# Public domain.

TOLF = dos2unix -q
TOCRLF = unix2dos -q
TOGBK = recode UTF-8..GBK

VER_GEN = $(if $(MINORVER),$(MAJORVER)$(1)$(MINORVER),$(MAJORVER))
PROJECT = $(TITLE)-$(call VER_GEN,)
DIST_DOC = $(PROJECT)/doc
DOC_UTF8LF = $(DIST_DOC)/utf8lf
DOC_GBKCRLF = $(DIST_DOC)/gbkcrlf
KPSE_CP = cp $(shell kpsewhich '$(1)') $(PROJECT)/tex/$(1)

dist: dist-clean dist-dir doc-utf8lf doc-gbkcrlf pdf-license biblatex dist-zip

dist-dir: tex/ doc/
	mkdir -p $(DIST_DOC)/
	cp -r tex/ $(PROJECT)/

doc-utf8lf:
	make toutf8lf
	cp -r doc/ $(DOC_UTF8LF)/

doc-gbkcrlf:
	make togbkcrlf
	cp -r doc/ $(DOC_GBKCRLF)/
	make toutf8lf

pdf-license: doc/
	cd doc && make
	mv doc/$(TITLE).pdf $(PROJECT)/$(README).pdf
	cd doc && make dist-clean
	mv -f $(DOC_UTF8LF)/license/ $(PROJECT)/
	rm -rf $(DOC_GBKCRLF)/license/

biblatex:
	$(call KPSE_CP,caspervector.bbx)
	$(call KPSE_CP,caspervector.cbx)
	$(call KPSE_CP,biblatex-caspervector-utf8.def)
	$(call KPSE_CP,biblatex-caspervector-gbk.def)

dist-zip: $(PROJECT)
	zip -rmT $(PROJECT).zip $(PROJECT)/

dist-clean:
	cd doc && make dist-clean
	rm -rf $(PROJECT)/ $(PROJECT).zip

